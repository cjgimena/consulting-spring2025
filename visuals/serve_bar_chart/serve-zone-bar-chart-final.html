<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Serve Placement Grid</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #f5f5f5;
      font-family: sans-serif;
    }
  </style>
</head>

<body>
  <svg width="900" height="400"></svg>

  <script>
    d3.json("serve_zone_bar_chart_sample.json").then(function (data) {
      const svg = d3.select("svg");

      const boxWidth = 300;
      const boxHeight = 250;
      const padding = 50;
      const blockHeight = 80;
      const blockSpacing = 1;
      const topMargin = 100;

      const colors = ["#052B4F", "#0A4D7E", "#3583C4"];

      function normalizeSide(side) {
        const values = [side.t, side.body, side.wide];
        const total = d3.sum(values);
        return values.map(v => Math.round((v / total) * 100));
      }

      const charts = ["First Serve", "Second Serve"].map((label, i) => {
        const serve = data.serves.find(d => d.type === label);
        return {
          label: label,
          x: i * (boxWidth + padding) + padding,
          ad: normalizeSide(serve.sides.ad),
          deuce: normalizeSide(serve.sides.deuce),
          count: d3.sum([
            serve.sides.ad.t, serve.sides.ad.body, serve.sides.ad.wide,
            serve.sides.deuce.t, serve.sides.deuce.body, serve.sides.deuce.wide
          ])
        };
      });

      charts.forEach((chart, i) => {
        const baseY = topMargin;

        svg.append("rect")
          .attr("x", chart.x)
          .attr("y", baseY)
          .attr("width", boxWidth)
          .attr("height", boxHeight)
          .attr("fill", "none")
          .attr("stroke", "#444")
          .attr("stroke-width", 2)
          .attr("stroke-dasharray", "8,4");

        svg.append("text")
          .attr("x", chart.x + boxWidth / 2)
          .attr("y", baseY - 15)
          .attr("text-anchor", "middle")
          .attr("font-size", "18px")
          .attr("fill", "#000")
          .text(chart.label);

        const rowLabels = ["Ad", "Deuce"];
        const rowData = [chart.ad, chart.deuce];

        const maxRowWidth = 240;

        rowData.forEach((values, rowIndex) => {
          const y = baseY + 30 + rowIndex * (blockHeight + 30);

          const totalWidth = d3.sum(values.map(v => (v / 100) * maxRowWidth)) + (values.length - 1) * blockSpacing;
          let x = chart.x + (boxWidth - totalWidth) / 2;
          values.forEach((val, j) => {
            const proportionalWidth = (val / 100) * maxRowWidth;

            svg.append("rect")
              .attr("x", x)
              .attr("y", y)
              .attr("width", proportionalWidth)
              .attr("height", blockHeight)
              .attr("rx", 8)
              .attr("ry", 8)
              .attr("fill", colors[j]);

            svg.append("text")
              .attr("x", x + proportionalWidth / 2)
              .attr("y", y + blockHeight / 2 + 5)
              .attr("text-anchor", "middle")
              .attr("fill", "white")
              .attr("font-size", "16px")
              .text(`${val}%`);

            x += proportionalWidth + blockSpacing;
          });
        });
      });
    });
  </script>
</body>

</html>